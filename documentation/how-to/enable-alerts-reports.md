# Enable alerts and reports
This guide describes how to enable the email alerts and reports feature of Superset.

In order to enable the feature, the following conditions must be met on the charm deployment:
1. `ALERT_REPORTS` feature flag is enabled.
2. `server-alias` configuration is set.
3. `smtp-secret-id` configuration is set.

## Enabling the feature flag
Suppose Superset was deployed with the following:
```sh
juju deploy superset-k8s --config feature-flags="$MY_FLAGS" superset-ui
juju deploy superset-k8s --config charm-function=beat --config feature-flags="$MY_FLAGS" superset-beat
juju deploy superset-k8s --config charm-function=worker --config feature-flags="$MY_FLAGS" superset-worker
```

Then, to enable `ALERT_REPORTS` add it to the list of the feature flags:
```sh
juju config superset-ui feature-flags="$MY_FLAGS,ALERT_REPORTS"
juju config superset-beat feature-flags="$MY_FLAGS,ALERT_REPORTS"
juju config superset-worker feature-flags="$MY_FLAGS,ALERT_REPORTS"
```

## Setting the server alias configuration
Suppose Superset was deployed with the following:
```sh
juju deploy superset-k8s --config feature-flags="$MY_FLAGS,ALERT_REPORTS" superset-ui
juju deploy superset-k8s --config charm-function=beat --config feature-flags="$MY_FLAGS,ALERT_REPORTS" superset-beat
juju deploy superset-k8s --config charm-function=worker --config feature-flags="$MY_FLAGS,ALERT_REPORTS" superset-worker
```

Then, make sure the following configuration is set to a valid value:
```sh
juju config superset-worker server-alias="<alias>"
```

Reports are generated by the workers imitating actual users to browse the UI via an URL constructed from `server-alias`.
Thus, the value for `server-alias` should allow a worker pod to reach the UI pod. This can be
a Kubernetes provided domain. Assuming the UI is deployed as `superset-ui` and the worker is deployed in the same model,
a good value for this key is `superset-ui`. You can check the 
[Kubernetes documentation](https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/) for more complex setups.

## Setting the SMTP secret ID configuration
Suppose Superset was deployed with the following:
```sh
juju deploy superset-k8s --config feature-flags="$MY_FLAGS,ALERT_REPORTS" superset-ui
juju deploy superset-k8s --config charm-function=beat --config feature-flags="$MY_FLAGS,ALERT_REPORTS" superset-beat
juju deploy superset-k8s --config charm-function=worker --config feature-flags="$MY_FLAGS,ALERT_REPORTS" superset-worker
```

First, create a file as such:
```yaml
host: <string>
port: <int>
username: <string>
password: <string>
email: <string>  # Sender of the emails
email-subject-prefix: <optional[string]>  # Prefix to use for the subject, '[Superset] ' by default
superset-external-url: <string>  # URL that will be used to generate the links in the email reports
ssl: <bool>
starttls: <bool>
ssl-server-auth: <bool>  # True, if you are using a valid certificate for the SMTP server
```

The value `superset-external-url` will be used to generate the links, so it should match a valid URL that allows users
to access your Superset deployment from their browsers.

[note]
The keys generally correspond to the values under the `Email configuration` section from the
[official documentation](https://superset.apache.org/docs/configuration/alerts-reports/#detailed-config).
[/note]

Second, create a secret from your file:
```sh
juju add-secret smtp-config --file=/path/to/file
```

Its output will be of the format `secret:<secret-id>`, copy the `<secret-id>` then grant access and set it in the configuration:
```sh
juju grant-secret <secret-id> superset-ui
juju grant-secret <secret-id> superset-beat
juju grant-secret <secret-id> superset-worker
juju config superset-ui smtp-secret-id=<secret-id>
juju config superset-beat smtp-secret-id=<secret-id>
juju config superset-worker smtp-secret-id=<secret-id>
```
