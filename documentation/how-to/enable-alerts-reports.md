# Enable alerts and reports
This guide describes how to enable the email alerts and reports feature of Superset.

In order to enable the feature, the following conditions must be met on the charm deployment:
1. `ALERT_REPORTS` feature flag is enabled.
2. `server-alias` configuration is set.
3. `smtp-secret-id` configuration is set.

Assume Superset was deployed with the following:
```sh
juju deploy superset-k8s --config feature-flags="$MY_FLAGS" superset-ui
juju deploy superset-k8s --config charm-function=beat --config feature-flags="$MY_FLAGS" superset-beat
juju deploy superset-k8s --config charm-function=worker --config feature-flags="$MY_FLAGS" superset-worker
```

## Setting the SMTP secret ID configuration
First, create a file as such:
```yaml
host: <string>
port: <int>
username: <string>
password: <string>
email: <string>  # Sender of the emails
email-subject-prefix: <optional[string]>  # Prefix to use for the subject, '[Superset] ' by default
superset-external-url: <string>  # URL that will be used to generate the links in the email reports
ssl: <bool>
starttls: <bool>
ssl-server-auth: <bool>  # True, if you are using a valid certificate for the SMTP server
```

The value `superset-external-url` will be used to generate the links, so it should match a valid URL that allows users
to access your Superset deployment from their browsers.

[note]
The keys generally correspond to the values under the `Email configuration` section from the
[official documentation](https://superset.apache.org/docs/configuration/alerts-reports/#detailed-config).
[/note]

Second, create a secret from your file:
```sh
juju add-secret smtp-config --file=/path/to/file
```

Its output will be of the format `secret:<secret-id>`, copy the `<secret-id>` then grant access to the applications:
```sh
juju grant-secret <secret-id> superset-ui
juju grant-secret <secret-id> superset-beat
juju grant-secret <secret-id> superset-worker
```

## Setting the configurations
After the deployment and the creation of the secret, the following will configure the applications to enable alerts and reports:
```sh
juju config superset-ui \
    feature-flags="$MY_FLAGS,ALERT_REPORTS" \
    server-alias="<alias>" \
    smtp-secret-id="<secret-id>"
juju config superset-beat \
    feature-flags="$MY_FLAGS,ALERT_REPORTS" \
    server-alias="<alias>" \
    smtp-secret-id="<secret-id>"
juju config superset-worker \
    feature-flags="$MY_FLAGS,ALERT_REPORTS" \
    server-alias="<alias>" \
    smtp-secret-id="<secret-id>"
```

The alerts feature is enabled by setting `ALERT_REPORTS` in the `feature-flags` configuration variable.

Reports are generated by the workers imitating actual users to browse the UI via a URL constructed from `server-alias`.
Thus, the value for `server-alias` should allow a worker pod to reach the UI pod. This can be
a Kubernetes provided domain. Assuming the UI is deployed as `superset-ui` and the worker is deployed in the same model,
a good value for this key is `superset-ui`. 

[note]
You can check the [Kubernetes documentation](https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/) 
for `server-alias` values in more complex setups.
[/note]

Finally, we pass the secret ID we got from the previous step to the applications so that they can make use of the credentials.
