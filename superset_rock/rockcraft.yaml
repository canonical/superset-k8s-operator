# Copyright 2023 Canonical Ltd.
# See LICENSE file for licensing details.
---
# https://github.com/apache/superset/blob/master/Dockerfile
name: superset
base: ubuntu@24.04
version: 6.0.0-24.04-edge
summary: Charmed Superset ROCK OCI
description: |
  Superset is a business intelligence tool that is fast, lightweight,
  intuitive, and loaded with options that make it easy for users
  to explore and visualize their data.
license: Apache-2.0

services:
  superset-ui:
    override: replace
    summary: "superset-ui service"
    startup: disabled
    command: "/app/k8s/k8s-bootstrap.sh"
    environment:
      CHARM_FUNCTION: "app-gunicorn"
      SUPERSET_SECRET_KEY: "supersetR0cks!"
      ADMIN_PASSWORD: "admin"
      SUPERSET_LOAD_EXAMPLES: "true"
  statsd-exporter:
    override: replace
    summary: "statsd metrics exporter"
    startup: disabled
    command: "/usr/bin/statsd_exporter"

platforms:
  amd64:

package-repositories:
  - type: apt
    key-server: https://packages.mozilla.org/apt/repo-signing-key.gpg
    key-id: 35BAA0B33E9EB396F59CA838C0BA5CE6DC6315A3
    url: https://packages.mozilla.org/apt
    priority: always
    components: [main]
    suites: [mozilla]

# Please refer to
# https://discourse.ubuntu.com/t/unifying-user-identity-across-snaps-and-rocks/36469
# for more information about shared user.
# The UID 584792 corresponds to _daemon_ user.
run_user: _daemon_

parts:
  superset:
    after: [dependencies]
    plugin: python
    source: https://github.com/apache/superset/archive/refs/tags/6.0.0.tar.gz  # yamllint disable-line
    source-checksum: sha512/99a5b09ff6f214cc4b3462f3c61f93994bf436ca7dfeb70a2ff763dcff585ba3bbfb7c568a5191ba180139777bf82b61e01cdfb605da29733d1b463b51dcb589  # yamllint disable-line
    source-type: tar
    build-packages:
      - build-essential
    stage-packages:
      # we must explicitly use python3, otherwise the symlink won't be created and superset binary shebang cannot start
      - python3-venv

    stage:
      # 'python3-venv' package comes with 'ca-certificates' as a dependency. If we don't exclude the files,
      # it will crash on 'overlay-pkgs' due to conflicting file permissions as it cannot override them
      - -usr/lib/ssl/cert.pem
      - -usr/lib/ssl/certs
      - -usr/lib/ssl/openssl.cnf
      - -usr/lib/ssl/private

  local-files:
    plugin: dump
    source: ./startup-scripts
    organize:
      run-server.sh: app/k8s/run-server.sh
      k8s-init.sh: app/k8s/k8s-init.sh
      k8s-bootstrap.sh: app/k8s/k8s-bootstrap.sh
      rock-requirements.txt: requirements/rock.txt
    stage:
      - app/k8s/run-server.sh
      - app/k8s/k8s-init.sh
      - app/k8s/k8s-bootstrap.sh
      - requirements/rock.txt
    permissions:
      - path: app/k8s
        owner: 584792
        group: 584792
        mode: "755"
      - path: requirements
        owner: 584792
        group: 584792
        mode: "755"

  frontend:
    plugin: nil
    source: https://github.com/apache/superset/archive/refs/tags/6.0.0.tar.gz  # yamllint disable-line
    source-checksum: sha512/99a5b09ff6f214cc4b3462f3c61f93994bf436ca7dfeb70a2ff763dcff585ba3bbfb7c568a5191ba180139777bf82b61e01cdfb605da29733d1b463b51dcb589  # yamllint disable-line
    source-type: tar
    build-packages:
      - git
      - zstd
    build-snaps:
      - node/20/stable
    override-build: |
      # Prepare for asset creation
      cd superset-frontend

      npm i --save-dev @types/underscore \
        @types/urijs \
        @types/mapbox__geojson-extent

      npm install @loaders.gl/core \
        @loaders.gl/loader-utils \
        @react-spring/web

      npm install dom-to-image \
        currencyformatter.js --save

      # Install frontend dependencies and build assets
      npm ci
      npm run build -- --output-path=${CRAFT_PART_INSTALL}/assets
    organize:
      assets: lib/python3.12/site-packages/superset/static/assets
    stage:
      - lib/python3.12/site-packages/superset/static/assets
    permissions:
      - path: lib/python3.12/site-packages/superset/static/assets
        owner: 584792
        group: 584792
        mode: "755"

  firefox:
      plugin: nil
      stage-packages:
        - firefox

  geckodriver:
      plugin: nil
      build-packages:
        - tar
        - wget
      build-environment:
        - GECKODRIVER_VERSION: '0.36.0'  # Update this when a new version is released
      override-build: |
        # Download geckodriver
        mkdir -p geckodriver-download
        cd geckodriver-download
        wget -q "https://github.com/mozilla/geckodriver/releases/download/v${GECKODRIVER_VERSION}/geckodriver-v${GECKODRIVER_VERSION}-linux64.tar.gz"
        tar -xzf geckodriver-v${GECKODRIVER_VERSION}-linux64.tar.gz
        mkdir -p ${CRAFT_PART_INSTALL}/opt/firefox
        install -m 755 geckodriver ${CRAFT_PART_INSTALL}/opt/firefox/geckodriver
        cd ..
        rm -rf geckodriver-download

      organize:
        opt/firefox/geckodriver: usr/bin/geckodriver

      permissions:
          - path: usr/bin/geckodriver
            mode: "755"
            owner: 584792
            group: 584792

  dependencies:
    after: [local-files]
    plugin: python
    source: https://github.com/apache/superset/archive/refs/tags/6.0.0.tar.gz  # yamllint disable-line
    source-checksum: sha512/99a5b09ff6f214cc4b3462f3c61f93994bf436ca7dfeb70a2ff763dcff585ba3bbfb7c568a5191ba180139777bf82b61e01cdfb605da29733d1b463b51dcb589  # yamllint disable-line
    source-type: tar
    build-packages:
      - build-essential
      - pkg-config
      - libmysqlclient-dev
    stage-packages:
      - python3-venv
    override-build: |
      # Install Superset requirements
      pip install --upgrade setuptools pip \
        -r requirements/base.txt \
          --target=${CRAFT_PART_INSTALL}/dist \
        -r ${CRAFT_STAGE}/requirements/rock.txt \
          --target=${CRAFT_PART_INSTALL}/dist

      # Copy current directory files to app
      cp -r . ${CRAFT_PART_INSTALL}/app

      # Copy webfront images to expected dir
      cd ${CRAFT_PART_INSTALL}/dist/flask_appbuilder/static/appbuilder/
      cp -r css/webfonts/ webfonts/

    organize:
      dist: usr/local/lib/python3.12/dist-packages
    stage:
      - app
      - usr/local/lib/python3.12/dist-packages
    permissions:
      - path: usr/local/lib/python3.12/dist-packages
        owner: 584792
        group: 584792
        mode: "755"

  prometheus-statsd-exporter:
    plugin: go
    source: https://github.com/prometheus/statsd_exporter.git
    source-tag: v0.28.0
    build-snaps:
      - go/latest/stable   # or whichever you standardize on
    override-build: |
      set -eux

      cd "${CRAFT_PART_SRC}"

      # Force the fixed dependency (CVE-2024-45337 fixed in v0.31.0)
      go mod edit -require=golang.org/x/crypto@v0.31.0
      go mod tidy

      export CGO_ENABLED=0
      go build -trimpath -ldflags="-s -w" -o "${CRAFT_PART_INSTALL}/bin/statsd_exporter" .
    stage:
      - bin/statsd_exporter
    permissions:
      - path: bin/statsd_exporter
        owner: 584792
        group: 584792
        mode: "755"

  prometheus-celery-exporter:
    plugin: dump
    source: https://github.com/canonical/celery-exporter/releases/download/celery-exporter-chart-0.8.0/celery-exporter # yamllint disable-line
    source-type: file
    organize:
      celery-exporter: bin/celery-exporter
    stage:
      - bin/celery-exporter
    permissions:
      - path: bin/celery-exporter
        owner: 584792
        group: 584792
        mode: "755"

  overlay-pkgs:
    after: [superset]
    plugin: nil
    overlay-packages:
      - ca-certificates
    stage-packages:
      - libecpg-dev
      - libmysqlclient-dev
